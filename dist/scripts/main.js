"use strict";geotab.addin.importFuelTransactions=function(){var e,t,n,r,o,a,i,s,c,u,l,d,m,f,p,g,v,C,h,E,y,b=10,N=function(e){e?(r.removeAttribute("disabled"),w(!1)):r.setAttribute("disabled","disabled")},w=function(e){e?o.removeAttribute("disabled"):(o.setAttribute("disabled","disabled"),L(!1),P())},L=function(e){e?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")},A=function(e){e?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled")},S=function(e,t){m.style.display="none",f.style.display="none",p.style.display="none",e&&(e.querySelector("span").textContent=t,e.style.display="block")},P=function(){for(;i.firstChild;)i.removeChild(i.firstChild)},D=function(e){P(),e.sort(),e.forEach(function(e){var t=document.createElement("OPTION");t.textContent=e,t.value=e,i.appendChild(t)}),e.length>0&&L(!0)},U=function(){for(l.style.display="none",d.style.display="block";u.firstChild;)u.removeChild(u.firstChild);h=[]},I=function(){U(),P(),N(!1),w(!1)},T=function(){var e,t=0,n=0,r=i.options[i.selectedIndex].value,o=function(e){var t={vehicleIdentificationNumber:"VIN",description:"Description",serialNumber:"Device Serial Number",licencePlate:"Licence Plate",comments:"Comment",dateTime:"Date (UTC)",volume:"Volume Added (litres)",odometer:"Odometer (km)",cost:"Cost",currencyCode:"Currency",location:"Location (lon,lat)",provider:"File Provider",driverName:"Driver Name",productType:"Product Type"};return t[e]||e},a=function(e,t){var n=document.createElement("TR"),r=function(r){if("sourceData"!==r&&"fleet"!==r){var a=document.createElement(t?"TH":"TD");a.textContent=t?o(r):JSON.stringify(e[r]),t||a.setAttribute("data-th",r),n.appendChild(a)}};return Object.keys(e).forEach(r),n};for(l.style.display="none",d.style.display="block";u.firstChild;)u.removeChild(u.firstChild);e=document.createElement("TBODY"),h.forEach(function(o,i){var s;0===i&&(s=document.createElement("THEAD"),s.appendChild(a(o,!0)),u.appendChild(s)),r&&o.fleet!==r||(n++,t<b&&(t++,e.appendChild(a(o))))}),C.textContent=(b===t?"top ":"")+t+"/"+n,u.appendChild(e),l.style.display="block",d.style.display="none"},O=function(){n.value=null,c.value=""},x=function(){return window.location.protocol+"//"+window.location.hostname+"/apiv1"},k=function(e){var t;t=e.target.files?e.target.files[0]:{name:n.value.substring(n.value.lastIndexOf("\\")+1,n.length)},t&&(c.value=t.name,N(!0),U()),S()},B=function(e,t,n,r,o,a,i,s,c,u,l,d,m,f,p){var g={vehicleIdentificationNumber:e||"",description:t||"",serialNumber:n||"",licencePlate:r||"",comments:o||"",dateTime:a,volume:i,odometer:s,cost:c,currencyCode:u,location:l,provider:d,driverName:m,sourceData:f,productType:p};return g},M=function(){var t=this,n=new RegExp(" ","g"),r={unknown:0,wex:2,wexCustomer:3,fleetcore:4,geotab:1e3},o=function(e){var t=e.split(".");return parseInt(t[2],10)>=1606},a=function(e){var t=e.length;return t>0&&'"'===e[0]&&(e=e.substring(1,e.length),t--,t>0&&'"'===e[t-1]&&(e=e.substring(0,e.length-1))),"(null)"===e?"":e.trim()},i=function(e){var t=parseFloat(e);return isNaN(t)?0:t},s=function(e){var t,n=new Date(e),r=function(e){var t=new Date(Date.UTC(1899,11,30)),n=864e5,r=new Date;return r.setTime(e*n+Date.parse(t)),r};return e.indexOf("T")>-1?n.toISOString():(t=new Date(Date.UTC(n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getMilliseconds())),isNaN(t.getTime())?r(i(e)).toISOString():t.toISOString())},c=function(e){return e/.62137},u=function(e){return 3.785*e},l={wex:function(e,t){var r=function(e){var t=parseInt(e,10)||0;switch(t){case 21:case 22:case 23:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 49:case 50:case 52:case 53:case 54:case 55:case 56:case 57:case 58:case 59:case 60:case 62:case 63:case 64:case 65:case 66:case 67:case 68:case 70:case 71:case 72:case 73:case 74:case 79:case 80:case 81:case 82:case 83:case 84:case 85:case 90:return"NonFuel";case 3:case 7:case 12:case 15:return"Regular";case 4:case 6:case 8:case 13:case 14:case 16:case 17:case 20:return"Premium";case 2:case 9:return"Diesel";case 1:return"E85";case 11:return"CNG";case 10:return"LPG";default:return"Unknown"}};return new Promise(function(o){var l=[];return t.forEach(function(t){var o,d={};Object.keys(e).forEach(function(r){d[e[r].replace(n,"")]=t[r]}),t.ColumnN&&(o=new B(a(t.ColumnJ),a(t.ColumnI),"",a(t.ColumnG),"",s(a(t.ColumnAK)),u(i(a(t.ColumnN))),c(i(a(t.ColumnAH))),i(a(t.ColumnO)),"USD",{x:i(a(t.ColumnAM)),y:i(a(t.ColumnAL))},"Wex",(a(t.ColumnU)+" "+a(t.ColumnV)+" "+a(t.ColumnT)).trim(),JSON.stringify(d),r(a(t.ColumnQ))),o.fleet=a(t.ColumnA),l.push(o))}),o(l)})},wexCustomer:function(t,r){return o(y)?new Promise(function(o,l){var d=[],m={},p=[],g=new Promise(function(e){e()}),v=100,C="Parsing: converting addresses to coordinates... ",h="Parsing: finding timezone of coordinates... ",y=function(t,n,r,o){return function(a){return new Promise(function(i){e.call(t,n,function(e){var t=a.concat(e);S(f,r+t.length+"/"+o),i(t)},l)})}},b=function(){var e,t=new Promise(function(e){e([])});for(S(f,C),e=0;e<p.length;e+=v)t=t.then(y("GetCoordinates",{addresses:p.slice(e,e+v)},C,p.length));return new Promise(function(e){t.then(function(t){e({addresses:p,coordinates:t})})})},N=function(e){var t=[];return e.addresses.forEach(function(n,r){var o=e.coordinates[r];o?m[n].coordinates=o:t.push(n)}),t},w=function(e){var t,n=new Promise(function(e){e([])}),r=function(e){var t=e.split(",");return t.slice(1,t.length).join(",")};for(t=0;t<e.length;t+=v)n=n.then(y("GetCoordinates",{addresses:e.slice(t,t+v).map(r)}));return new Promise(function(t){n.then(function(n){t({addresses:e,coordinates:n})})})},L=function(){var e,t=(new Date).toISOString(),n=new Promise(function(e){e([])}),r=function(e){var n=m[e].coordinates;return{x:n.x,y:n.y,dateTime:t}};for(S(f,C),e=0;e<p.length;e+=v)n=n.then(y("GetCoordinateTimeZones",{coordinates:p.slice(e,e+v).map(r)},h,p.length));return n},A=function(e){p.forEach(function(t,n){m[t].timezone=e[n]})},P=function(){d.forEach(function(e){var t=m[e.address];!t.coordinates||0===t.coordinates.x&&0===t.coordinates.y?console.log("Invalid coordinates returned for address: "+e.address):e.location=t.coordinates,t.timezone?e.dateTime=D(e.dateTime,t.timezone.id):console.log("Invalid timezone returned for coordinates: "+e.address+" "+JSON.stringify(e.location)),delete e.address})},D=function(e,t){return t?moment.tz(e.replace("T"," ").replace("Z",""),t).toISOString():e},U=function(e){switch(e){case"UNa":case"UNb":case"UNc":case"UNL":case"UNLEADED":case"UNLALC57":case"UNLALC10":case"UNLALC77":return"Regular";case"SUP":case"UN+":case"U+c":case"U+a":case"SUa":case"U+b":case"SUb":case"SUc":case"SUPER UN":case"UNL PLUS":case"UN+ALC57":case"UN+ALC10":case"SUPALC10":case"UN+ALC77":case"SUPALC77":case"SUPALC57":case"PREMIUM":case"UN+EADED PLUS":case"SUPER UNLEADED":return"Premium";case"DIESEL":case"PREM DSL":case"DSL":case"DS+":case"DSLDIESEL":return"Diesel";case"ETHANL85":case"E85":case"E85ETHANOL85":return"E85";case"CNG":return"CNG";case"PRO":case"PROPANE":return"LPG";default:return"Unknown"}};r.forEach(function(e){var r,o={};Object.keys(t).forEach(function(r){o[t[r].replace(n,"")]=e[r]}),e.ColumnS?(r=new B("",a(e.ColumnC),"","","",s((i(e.ColumnD)+i(e.ColumnE)).toFixed(15)),u(i(e.ColumnS)),c(i(e.ColumnO)),i(e.ColumnAA),"USD",null,"WexCustomer",a(e.ColumnL),JSON.stringify(o),U(a(e.ColumnR))),r.address=a(e.ColumnH)+", "+a(e.ColumnI)+", "+a(e.ColumnJ)+", "+a(e.ColumnK),m[r.address]={coordinates:null,timezone:null},r.fleet=a(E),d.push(r)):console.log("Skipped row")}),p=Object.keys(m),g.then(b).then(N).then(w).then(N).then(L).then(A).then(P).then(function(){o(d)})["catch"](l)}):new Promise(function(e,t){t(new Error("Your server is not running a version that supports WEX Customer files. The minimum version is 5.7.1606.0 this server is "+y+"."))})},geotab:function(e,t){var r=function(e){var t=e.toLowerCase().replace(" ","");switch(t){case"nonfuel":return"NonFuel";case"regular":return"Regular";case"midgrade":return"Midgrade";case"premium":return"Premium";case"super":return"Super";case"diesel":return"Diesel";case"e85":return"E85";case"cng":return"CNG";case"lpg":return"LPG";default:return"Unknown"}};return new Promise(function(o){var c=[];return t.forEach(function(t){var o,u={};Object.keys(e).forEach(function(r){u[e[r].replace(n,"")]=t[r]}),t.hasOwnProperty("ColumnM")&&(o=new B(a(t.ColumnA),a(t.ColumnB),a(t.ColumnC),a(t.ColumnD),a(t.ColumnE),s(t.ColumnF),i(t.ColumnG),i(t.ColumnJ),i(t.ColumnH),a(t.ColumnI),{x:i(t.ColumnK),y:i(t.ColumnL)},"Unknown",a(t.ColumnM),JSON.stringify(u),r(a(t.ColumnN))),o.fleet=a(E),c.push(o))}),o(c)})}},d=function(e){var t=e[0],n=!0;return Object.keys(t).forEach(function(e){isNaN(parseInt(e,10))||(n=!1)}),n?e.shift():[]},m=function(e){return"VIN"===e.ColumnA&&"Driver Name"===e.ColumnM?r.geotab:"Fleet Name"===a(e.ColumnA)&&"ACCOUNT NUMBER 5"===a(e.ColumnB)?r.wex:"Card Number"===a(e.ColumnA)&&"Vehicle Card Department"===a(e.ColumnB)?r.wexCustomer:r.unknown},p=function(e,t,n){switch(e){case r.wex:return l.wex(t,n);case r.wexCustomer:return l.wexCustomer(t,n);case r.geotab:return l.geotab(t,n);default:return null}};return t.parse=function(e){var t,n=d(e);return n?(t=m(n),t===r.unknown?new Promise(function(e,t){t(new Error("unrecognised file provider"))}):p(t,n,e)):new Promise(function(e,t){t(new Error("missing row headings in file"))})},t},R=function(e){var t,n,r;return e.target&&e.target.responseText.length>0?(t=JSON.parse(e.target.responseText),t.error?r=t.error:n=t.result):r={message:"No data"},{error:r,data:n}},G=function(e){var t,n=new M,r=function(e){var t={};return e.forEach(function(e){t[e.fleet]=e.fleet||E}),Object.keys(t)};return O(),t=R(e),t.error?void S(p,t.error.message):void n.parse(t.data).then(function(e){return h=e,null===h?void S(p,"Can not determine file provider type, try converting to MyGeotab file type"):h.length?(D(r(h)),w(!0),T(h),void S()):void S(p,"No transactions found in file")})["catch"](function(e){S(p,"Error parsing file: "+(e.message||e))})},F=function(e,t,n){var r=document.createElement("iframe"),o=e.querySelector('input[type="hidden"]'),a=function i(e){var t;e.preventDefault(),e.stopPropagation(),r.removeEventListener("load",i,!1),r.contentDocument?t=r.contentDocument.body.innerHTML:r.contentWindow?t=r.contentWindow.document.body.innerHTML:r.document&&(t=r.document.body.innerHTML),G({target:{responseText:t}}),setTimeout(function(){r.parentNode.removeChild(r)},250)};o.value=n,r.setAttribute("id","upload_iframe"),r.setAttribute("name","upload_iframe"),r.setAttribute("width","0"),r.setAttribute("height","0"),r.setAttribute("border","0"),r.setAttribute("style","width: 0; height: 0; border: none;"),e.parentNode.appendChild(r),window.frames.upload_iframe.name="upload_iframe",r.addEventListener("load",a,!0),e.setAttribute("target","upload_iframe"),e.setAttribute("action",t),e.setAttribute("method","post"),e.setAttribute("enctype","multipart/form-data"),e.setAttribute("encoding","multipart/form-data"),e.submit()},H=function(t){t.preventDefault(),S(f,"Parsing... transferring file"),e.getSession(function(e){var t,r,o=JSON.stringify({id:-1,method:"ExcelToJson",params:{minColumnsAmount:28,credentials:e}});window.FormData?(t=new FormData,r=new XMLHttpRequest,t.append("JSON-RPC",o),t.append("fileToUpload",n.files[0]),r.upload.addEventListener("progress",J,!1),r.addEventListener("load",G,!1),r.addEventListener("error",j,!1),r.addEventListener("abort",j,!1),r.open("POST",x()),r.send(t)):F(v,x(),o),E=e.database,N(!1)})},J=function(e){if(e.lengthComputable){var t=Math.round(100*e.loaded/e.tota);t<100?S(f,"Parsing: transferring file "+t.toString()+"%"):S(f,"Parsing: converting csv to fuel transactions")}},j=function(){S(p,"There was an error attempting to upload the file.")},z=function(){var t,n,r=i.options[i.selectedIndex].value,o=[],a=[],s=100,c=0,u=0,l="Importing fuel transactions...",d=function(e){c+="string"==typeof e?1:e.length},g=function(t){return new Promise(function(n,r){e.multiCall(t,n,r)})},v=function(){var e=o.pop();return function(t){return d(t),S(f,l+" "+c+"/"+u),g(e)}};for(w(!1),A(!1),S(f,l),h.forEach(function(e,t){r&&e.fleet!==r||(a.push(["Add",{typeName:"FuelTransaction",entity:e}]),u++),a.length!==s&&t!==h.length-1||(o.push(a),a=[])}),t=g(o.pop()),n=0;n<o.length;n++)t=t.then(v()),n--;t.then(function(e){d(e),I(),S(m,c),A(!0)})["catch"](function(e){A(!0),S(p,e.toString())})},V=function(e){var t=e.target.checked;t?e.target.parentNode.className+=" active":e.target.parentNode.className=e.target.parentNode.className.replace("active",""),g.style.display=t?"block":"none"};return{initialize:function(h,E,b){e=h,t=document.getElementById("importFuelTransactions"),n=document.getElementById("files"),r=document.getElementById("parseButton"),o=document.getElementById("importButton"),a=document.getElementById("cancelButton"),i=document.getElementById("fleet"),s=document.getElementById("exampleButton"),c=document.getElementById("fileName"),u=document.getElementById("transactionList"),l=document.getElementById("transactionContainer"),d=document.getElementById("fileSelectContainer"),f=document.getElementById("alertInfo"),m=document.getElementById("alertSuccess"),p=document.getElementById("alertError"),g=document.getElementById("sample"),v=document.getElementById("form"),C=document.getElementById("listCount"),e.call("GetVersion",{},function(e){y=e,b()},function(e){S(p,e.toString()),b()})},focus:function(){n.addEventListener("change",k,!1),r.addEventListener("click",H,!1),o.addEventListener("click",z,!1),i.addEventListener("change",T,!1),s.addEventListener("change",V,!1),a.addEventListener("click",I,!1),t.style.display="block"},blur:function(){n.removeEventListener("change",k,!1),r.removeEventListener("click",H,!1),o.removeEventListener("click",z,!1),i.removeEventListener("change",T,!1),s.removeEventListener("change",V,!1),a.removeEventListener("click",I,!1)}}};